---
# yamllint disable rule:line-length

.rule_skip-ci: &rule_skip-ci
  - if: $CI_COMMIT_MESSAGE =~ /\[skip pipeline\]/
    when: never

stages:
  - init
  - code_check
  - apply_sbx
  - destroy_sbx
  - post_merge_git_tag
  - post_merge_terra_doc
  - apply_dev

include:
  - project: 'nodeai/pipeline-templates'
    ref: main
    file:
      - 'git/actions.yml'
      - 'terraform/commands.yml'
      - 'terraform/scans.yml'
      - 'terraform/docs.yml'

########################
### Pre Merge
########################
git_version_gating:
  stage: init
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never

terraform_scan_tfsec:
  stage: code_check
  variables:
    TFVARS_PATH: "vars"
    ENVIRONMENT: 'sandbox'
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^feature/

terraform_cmd_validate:
  stage: code_check
  variables:
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^feature/

terraform_cmd_fmt:
  stage: code_check
  variables:
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^feature/

terraform_plan_sbx:
  extends: .terraform_cmd_plan
  stage: code_check
  variables:
    TFVARS_PATH: "vars"
    ENVIRONMENT: 'sandbox'
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^feature/

########################
### Merge Request
########################
terraform_apply_sbx:
  extends: .terraform_cmd_apply
  stage: apply_sbx
  variables:
    TFVARS_PATH: "vars"
    ENVIRONMENT: 'sandbox'
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never

terraform_destroy_sbx:
  extends: .terraform_cmd_destroy
  stage: destroy_sbx
  variables:
    TFVARS_PATH: "vars"
    ENVIRONMENT: 'sandbox'
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # only on merge requests
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'  # if it's a push to a branch and there is an open merge request: never run it
      when: never
  when: always

########################
### Post Merge
########################
git_actions_tag:
  stage: post_merge_git_tag
  rules:
    - *rule_skip-ci
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'  # only when merged to main

terraform_docs_readme:
  stage: post_merge_terra_doc
  rules:
    - *rule_skip-ci
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'  # only when merged to main

terraform_apply_dev:
  extends: .terraform_cmd_apply
  stage: apply_dev
  variables:
    TFVARS_PATH: "vars"
    ENVIRONMENT: 'dev'
    TERRAFORM_DIR: '.'
  rules:
    - *rule_skip-ci
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'  # only when merged to main
